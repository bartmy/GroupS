<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GroupS - in development</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/purecss@1.0.0/build/pure-min.css"
      integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <main style="width: 40%; margin: 0 auto">
      <div id="login" style="text-align: center">
        <h1>Welcome to GroupS</h1>
      </div>
      <form
        id="loginForm"
        class="pure-form pure-form-stacked"
        style="width: 60%; margin: 0 auto"
      >
        <fieldset>
          <label for="loginUsername">Username</label>
          <input
            type="text"
            id="loginUsername"
            class="pure-input-rounded pure-u-1"
            placeholder="Username"
          />
          <label for="loginPassword">Password</label>
          <input
            type="password"
            id="loginPassword"
            class="pure-input-rounded pure-u-1"
            placeholder="Password"
          />
        </fieldset>
        <fieldset id="langs" class="pure-u-1 pure-control-group">
          Loading...
        </fieldset>
        <button
          type="submit"
          id="signInBtn"
          class="pure-button pure-button-primary"
        >
          Sign in
        </button>
        <button
          type="submit"
          id="signUpBtn"
          class="pure-button pure-button-primary"
        >
          Sign up
        </button>
      </form>

      <form
        id="todoForm"
        class="pure-form"
        style="display: none; text-align: center"
      >
        <fieldset>
          <input
            id="todoText"
            class="pure-input-rounded pure-input-2-3"
            placeholder="new TODO"
          />
          <button id="addTodo" class="pure-button pure-button-primary">
            +
          </button>
        </fieldset>
        <fieldset id="allTodos"></fieldset>
      </form>

      <form
        id="registerForm"
        class="pure-form pure-form-aligned"
        style="display: none; text-align: center"
      >
        <fieldset>
          <div class="pure-control-group">
            <label for="registerUsername">Username</label>
            <input
              type="text"
              id="registerUsername"
              placeholder="username..."
            />
          </div>
          <div class="pure-control-group">
            <label for="registerPassword">Password</label>
            <input
              type="password"
              id="registerPassword"
              placeholder="password..."
            />
          </div>
          <div class="pure-control-group">
            <label for="registerEmail">Email Address</label>
            <input type="email" id="registerEmail" placeholder="email..." />
          </div>
          <div class="pure-controls">
            <button
              type="submit"
              id="addUser"
              class="pure-button pure-button-primary"
            >
              Submit
            </button>
          </div>
        </fieldset>
      </form>
    </main>
    <script>
      (function () {
        const HOME_URL = "http://localhost:8080/";
        const API_URL = `${API_URL}/api`;
        const TODO_API_URL = `${API_URL}/todos`;
        const LOGIN_API_URL = `${API_URL}/login`;
        const REGISTER_API_URL = `${API_URL}/register`;
        const PROFILE_URL = `${HOME_URL}/up`;

        const todoText = document.getElementById("todoText");
        const usernameText = document.getElementById("loginUsername");
        const passwordText = document.getElementById("loginPassword");

        initLoginForm();

        function initLoginForm() {
          const CODE_TO_EMOJI = {
            pl: "ðŸ‡µðŸ‡±",
            en: "ðŸ‡ºðŸ‡¸",
            de: "ðŸ‡©ðŸ‡ª",
            es: "ðŸ‡ªðŸ‡¸",
          };
          fetch(`${API_URL}/langs`)
            .then(processOkResponse)
            .then((langArr) => {
              document.getElementById("langs").innerHTML = langArr
                .map(
                  (lang) => `
              <label class="pure-radio">
                <input type="radio" name="lang" value="${lang.id}">
                ${CODE_TO_EMOJI[lang.code]}
              </label>`
                )
                .join("\n");
              initLoginFormClick();
            });
        }

        function initLoginFormClick() {
          const loginForm = document.getElementById("loginForm");

          document
            .getElementById("signInBtn")
            .addEventListener("click", (event) => {
              event.preventDefault();
              const formObj = {
                username: loginForm.elements.loginUsername.value,
                password: loginForm.elements.loginPassword.value,
                lang: loginForm.elements.lang.value,
              };
              fetch(`${LOGIN_API_URL}?${new URLSearchParams(formObj)}`)
                .then((response) => response.text())
                .then((text) => {
                  document.getElementById("login").innerHTML = `
                  <h1>${text}</h1>
                  `;
                  if (text === "login ok!") {
                    loginForm.remove();

                    change_page();
                  } else {
                    usernameText.value = "";
                    passwordText.value = "";
                  }
                });
            });
          initRegisterForm();
        }

        function initProfile(user) {
          fetch(`${PROFILE_URL}/${user.id}`)
            .then(processOkResponse)
            .then((user) => {
              document.innerHTML = `
                  <h1>hello ${user.username} !</h1>
                  <p>nice to see you, your email is ${user.email}</p>
                  `;
            })
            .then((response) => response.text())
            .then((text) => {
              document.getElementById("login").innerHTML = `
                  <h1>${text}</h1>
                  `;
            });
        }

        function initRegisterForm() {
          document
            .getElementById("signUpBtn")
            .addEventListener("click", (event) => {
              event.preventDefault();
              document.getElementById("loginForm").style.display = "none";
              document.getElementById("login").innerHTML = `
                  <h1>Register yourself</h1>`;
              initRegisterFormClick();
            });
        }

        function initRegisterFormClick() {
          document.getElementById("registerForm").style.display = "block";
          const registerForm = document.getElementById("registerForm");

          const registerUsernameText =
            document.getElementById("registerUsername");
          const registerPasswordText =
            document.getElementById("registerPassword");
          const registerEmailText = document.getElementById("registerEmail");

          document
            .getElementById("addUser")
            .addEventListener("click", (event) => {
              event.preventDefault();
              fetch(REGISTER_API_URL, {
                method: "POST",
                headers: {
                  Accept: "application/json",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  username: registerUsernameText.value,
                  password: registerPasswordText.value,
                  displayName: registerUsernameText.value,
                  email: registerEmailText.value,
                }),
              })
                .then(processOkResponse)
                .then(() => {
                  document.getElementById("login").innerHTML = `
                <h1>${registerUsernameText.value} has been registered</h1>`;
                })
                .then(
                  () => (
                    (registerUsernameText.value = ""),
                    (registerPasswordText.value = ""),
                    (registerEmailText.value = "")
                  )
                )
                .then(() => {
                  document.getElementById("registerForm").style.display =
                    "none";
                  document.getElementById("loginForm").style.display = "block";
                })
                .catch(console.warn);
            });
        }

        function initTodoForm() {
          fetch(TODO_API_URL)
            .then(processOkResponse)
            .then((todos) => todos.forEach(createNewTodo));

          document
            .getElementById("addTodo")
            .addEventListener("click", (event) => {
              event.preventDefault();
              fetch(TODO_API_URL, {
                method: "POST",
                headers: {
                  Accept: "application/json",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ text: todoText.value }),
              })
                .then(processOkResponse)
                .then(createNewTodo)
                .then(() => (todoText.value = ""))
                .catch(console.warn);
            });

          function createNewTodo(todo) {
            const label = document.createElement("label");
            label.classList.add("pure-checkbox");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = todo.done;
            checkbox.addEventListener("click", (event) => {
              event.preventDefault();
              fetch(`${TODO_API_URL}/${todo.id}`, { method: "PUT" })
                .then(processOkResponse)
                .then((updatedTodo) => (checkbox.checked = !!updatedTodo.done))
                .catch(console.warn);
            });
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${todo.text}`));
            document.getElementById("allTodos").appendChild(label);
          }
        }

        function change_page_register() {
          window.location.replace("register.html");
        }

        function change_page() {
          window.location.replace("menu.html");
        }

        function processOkResponse(response = {}) {
          if (response.ok) {
            return response.json();
          }
          throw new Error(`Status not 200 (${response.status})`);
        }
      })();
    </script>
  </body>
</html>
